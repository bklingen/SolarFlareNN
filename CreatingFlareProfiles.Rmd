---
title: "CreateFlareData"
output: pdf_document
date: "2023-05-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Function that obtains flare info from GOES website

Write function that takes in the two nc files (one for 1-min flux, the other one for identified flares), and returns the dataset of 1-min peak-fluxes, with an additional column whether a flare was identified.
```{r}
library(ncdf4)
library(dplyr)
library(readr)
library(RCurl)

makeFlaredf <- function(goesNr = 16, 
                        year = 2021, 
                        month = '01', 
                        day = '01',
                        type='b') {
  # Download 1-min flux info:
  if(goesNr >= 16) {
    fluxUrl0 = paste0('https://data.ngdc.noaa.gov/platforms/solar-space-observing-satellites/goes/goes', goesNr,'/l2/data/xrsf-l2-avg1m_science/', year, '/', month, '/')
  } else {
    fluxUrl0 = paste0('https://data.ngdc.noaa.gov/platforms/solar-space-observing-satellites/goes/goes', goesNr,'/l2/data/xrsf-l2-avg1m_science/', year, '/', month, '/')
  }
  fluxFileName = paste0('sci_xrsf-l2-avg1m_g', goesNr, '_d', year, month, day, '_v2-2-0.nc') 
  fluxUrl = paste0(fluxUrl0,fluxFileName)
  
  if(url.exists(fluxUrl)) {
    fluxDestFile <- paste0("C:/Users/bklingen/Downloads/Flares/flux", i, ".nc")
    download.file(fluxUrl, fluxDestFile, method = 'auto', mode='wb')
    Flux0 = nc_open(fluxDestFile)
    dfFlux = tibble(
      secs_since_2000 = ncvar_get(Flux0, varid="time"),
      Date = as.POSIXct(secs_since_2000, origin = "2000-01-01 12:00:00"),
      Flux = ncvar_get(Flux0, varid=paste0("xrs",type,"_flux")),
    )
    nc_close(Flux0)
    #file.remove(fluxDestFile)
  } else {
    dfFlux = tibble(
      as.Date(character())
    )
  }
    
  # Download flare occurrence info:
  if (goesNr >= 16) {
    flareUrl0 = paste0('https://data.ngdc.noaa.gov/platforms/solar-space-observing-satellites/goes/goes', goesNr, '/l2/data/xrsf-l2-flsum_science/', year, '/', month, '/')
  } else {
    flareUrl0 = paste0('https://www.ncei.noaa.gov/data/goes-space-environment-monitor/access/science/xrs/goes', goesNr, '/xrsf-l2-flsum_science/', year, '/', month, '/')
  }
  flareFileName = paste0('sci_xrsf-l2-flsum_g', goesNr, '_d', year, month, day, '_v2-2-0.nc')
  flareUrl = paste0(flareUrl0,flareFileName)
  
  if(url.exists(flareUrl)) {
    flareDestFile <- paste0("C:/Users/bklingen/Downloads/Flares/flare", i , ".nc")
    download.file(flareUrl, flareDestFile, method = 'auto', mode='wb')
    Flare0 = nc_open(flareDestFile)
    dfFlares = tibble(
      secs_since_2000 = ncvar_get(Flare0, varid="time"),
      Status = ncvar_get(Flare0, varid="status"),
    )
    nc_close(Flare0)
  } else {
    dfFlares = tibble(
      secs_since_2000 = integer(),
      Status = character(),
    )
  }
  ## joint dfFlux and dfFlare data:
  df = left_join( x = dfFlux,
                  y = dfFlares,
                  by = 'secs_since_2000')

  return(df %>% mutate(Flare = if_else(Status == 'EVENT_PEAK', 1, 0, missing = 0)))
}
```

## Create 2021 datafile of all identified flares
We obtain a dataset of all identified flares and supplement (at a ratio of `nonflareMultiple` non-flare profiles for every one flare profile) the dataset with non-flare profiles

Cycle over all 12 month in 2021:
```{r}
Flares2021 = tibble(
      secs_since_2000 = integer(),
      Date = as.Date(character()),
      Flux = numeric(),
      Status = character(),
      Flare = integer()
)

monthDays = c(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31)
monthNum = c('01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12') 


for (k in 1:12) {
  days <- formatC(seq(1, monthDays[k]), width = 2, format = "d", flag = "0")

  for(i in days) {
    df0 = makeFlaredf(
      goesNr = 16,
      year = 2021,
      month = monthNum[k],
      day = i, 
      type='b')
    Flares2021 = bind_rows(Flares2021,df0)
  }
}

# save(Flares2021, file="C:/Users/bklingen/Desktop/SolarFlareNN/Flares2021.r")

```

Now, create a matrix with 61 columns, where column nr. 31 is the time point at which a flare occurred, columns 1 - hist are the values of the previous hist fluxes (so, going back hist minutes), and columns 32 - 61 are the values of the hist fluxes after the declared flare:
```{r}
## Load in Flares2021 dataset
#load(file="C:/Users/bklingen/Desktop/SolarFlareNN/Flares2021.r")
flare_indices = which(Flares2021$Flare == 1)
numFlares = length(flare_indices)
hist1 = 60
hist2 = 30
nonflareMultiple = 30 # how many non-flares per flare
FlareProfiles = matrix(NA, nrow=numFlares, ncol=hist1 + hist2 + 1 + 1 + 1)
j = 1
for (i in flare_indices){
  if(i > hist1 && i <= nrow(Flares2021) - hist2) {
    FlareProfiles[j,] = c( ## standardize fluxes, equals 0 for flux at flare event
      #(Flares2021$Flux[i] - Flares2021$Flux[(i-hist1) : (i + hist2)]) / Flares2021$Flux[i],
      Flares2021$Flux[(i-hist1) : (i + hist2)] / Flares2021$Flux[i],
      1,
      Flares2021$secs_since_2000[i]
    )
    j = j + 1
  }
}

## Controls: pick random index:
NotFlareProfiles = matrix(NA, nrow=nonflareMultiple*numFlares, ncol=hist1 + hist2 + 1 + 1 + 1)
nonflare_indices = setdiff( #rule out those within 3 minutes of peak flare
  c((hist1 + 1) : (nrow(Flares2021)- (hist2 + 1))), 
  c(flare_indices, 
    flare_indices - 1, flare_indices - 2, flare_indices - 3, flare_indices - 4, flare_indices - 5, flare_indices - 6,
    flare_indices + 1, flare_indices + 2, flare_indices + 3, flare_indices - 4, flare_indices - 5, flare_indices - 6
    )
)
j = 1
for (i in sample(nonflare_indices, nonflareMultiple*numFlares)){ #select random index
  NotFlareProfiles[j,] = c(
    #(Flares2021$Flux[i] - Flares2021$Flux[(i-hist1) : (i + hist2)]) / Flares2021$Flux[i],
    Flares2021$Flux[(i-hist1) : (i + hist2)] / Flares2021$Flux[i],
    0,
    Flares2021$secs_since_2000[i]
  )
  j = j + 1
}

library(tidyr)
library(dplyr)
library(readr)
Profiles = as_tibble(rbind(FlareProfiles, NotFlareProfiles))
dim(Profiles)
colnames(Profiles) = c(paste0('x', 1:(hist1 + hist2 + 1)), 'y', 'SecsSince2000')

Profiles = Profiles %>% 
  drop_na() %>%  
  mutate(Date = as.POSIXct(SecsSince2000, origin = "2000-01-01 12:00:00")) %>% 
  select(-SecsSince2000)

ProfilesShuffeled2021 = Profiles[sample(1:nrow(Profiles)),]
save(ProfilesShuffeled2021, file="C:/Users/bklingen/Desktop/SolarFlareNN/ProfilesShuffeled2021.r")
#load(file="C:/Users/bklingen/Desktop/SolarFlareNN/ProfilesShuffeled2021.r")
library(readr)
write_csv(as.data.frame(ProfilesShuffeled2021) , file="C:/Users/bklingen/Desktop/SolarFlareNN/ProfilesShuffeled2021.csv")
```



## Get dataset for 2022 data:
Cycle over all 12 month in 2022:
```{r}
Flares2022 = tibble(
      secs_since_2000 = integer(),
      Date = as.Date(character()),
      Flux = numeric(),
      Status = character(),
      Flare = integer()
)

monthDays = c(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31)
monthNum = c('01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12') 


for (k in 1:12) {
  days <- formatC(seq(1, monthDays[k]), width = 2, format = "d", flag = "0")

  for(i in days) {
    df0 = makeFlaredf(
      goesNr = 16,
      year = 2022,
      month = monthNum[k],
      day = i, 
      type='b')
    Flares2022 = bind_rows(Flares2022,df0)
  }
}

#save(Flares2022, file="C:/Users/bklingen/Desktop/SolarFlareNN/Flares2022.r")

```

Now, create a matrix with 61 columns, where column nr. 31 is the time point at which a flare occurred, columns 1 - hist are the values of the previous hist fluxes (so, going back hist minutes), and columns 32 - 61 are the values of the hist fluxes after the declared flare:
```{r}
## Load in Flares2022 dataset
#load(file="C:/Users/bklingen/Desktop/SolarFlareNN/Flares2022.r")
flare_indices = which(Flares2022$Flare == 1)
numFlares = length(flare_indices)
FlareProfiles = matrix(NA, nrow=numFlares, ncol=hist1 + hist2 + 1 + 1 + 1)
j = 1
for (i in flare_indices){
  if(i > hist1 && i <= nrow(Flares2022) - hist2) {
    FlareProfiles[j,] = c( ## standardize fluxes, equals 0 for flux at flare event
      #(Flares2022$Flux[i] - Flares2022$Flux[(i-hist1) : (i + hist2)]) / Flares2022$Flux[i],
      Flares2022$Flux[(i-hist1) : (i + hist2)] / Flares2022$Flux[i],
      1,
      Flares2022$secs_since_2000[i]
    )
    j = j + 1
  }
}

## Controls: pick random index:
NotFlareProfiles = matrix(NA, nrow=nonflareMultiple*numFlares, ncol=hist1 + hist2 + 1 + 1 + 1)
nonflare_indices = setdiff( #rule out those within 3 minutes of peak flare
  c((hist1 + 1) : (nrow(Flares2022)- (hist2 + 1))), 
  c(flare_indices, 
    flare_indices - 1, flare_indices - 2, flare_indices - 3, flare_indices - 4, flare_indices - 5, flare_indices - 6,
    flare_indices + 1, flare_indices + 2, flare_indices + 3, flare_indices - 4, flare_indices - 5, flare_indices - 6
    )
)
j = 1
for (i in sample(nonflare_indices, nonflareMultiple*numFlares)){ #select random index
  NotFlareProfiles[j,] = c(
    #(Flares2022$Flux[i] - Flares2022$Flux[(i-hist1) : (i + hist2)]) / Flares2022$Flux[i],
    Flares2022$Flux[(i-hist1) : (i + hist2)] / Flares2022$Flux[i],
    0,
    Flares2022$secs_since_2000[i]
  )
  j = j + 1
}

library(tidyr)
library(dplyr)
library(readr)
Profiles = as_tibble(rbind(FlareProfiles, NotFlareProfiles))
dim(Profiles)
colnames(Profiles) = c(paste0('x', 1:(hist1 + hist2 + 1)), 'y', 'SecsSince2000')

Profiles = Profiles %>% 
  drop_na() %>%  
  mutate(Date = as.POSIXct(SecsSince2000, origin = "2000-01-01 12:00:00")) %>% 
  select(-SecsSince2000)

ProfilesShuffeled2022 = Profiles[sample(1:nrow(Profiles)),]
save(ProfilesShuffeled2022, file="C:/Users/bklingen/Desktop/SolarFlareNN/ProfilesShuffeled2022.r")
#load(file="C:/Users/bklingen/Desktop/SolarFlareNN/ProfilesShuffeled2022.r")
library(readr)
write_csv(as.data.frame(ProfilesShuffeled2022) , file="C:/Users/bklingen/Desktop/SolarFlareNN/ProfilesShuffeled2022.csv")
```


## Combine 2021 and 2022 data:
```{r}
ProfilesShuffeled2122 = rbind(ProfilesShuffeled2021, ProfilesShuffeled2022)
ProfilesShuffeled2122 = ProfilesShuffeled2122[sample(1:nrow(ProfilesShuffeled2122)),]
save(ProfilesShuffeled2122, file="C:/Users/bklingen/Desktop/SolarFlareNN/ProfilesShuffeled2122.r")
write_csv(as.data.frame(ProfilesShuffeled2122) , file="C:/Users/bklingen/Desktop/SolarFlareNN/ProfilesShuffeled2122.csv")
```

## Obtain January 2021 1-min profiles
```{r}
Jan21Flares = Flares2021 %>% filter(Date < '2021-02-01')
Jan21Indices = c((hist1 + 1) : (nrow(Jan21Flares) - (hist2 + 1)))

Jan21FlareProfiles = matrix(NA, nrow = length(Jan21Indices), ncol = hist1 + hist2 + 1 + 1 + 1)
j = 1
for (i in Jan21Indices) {
  Jan21FlareProfiles[j,] = c(
    (Jan21Flares$Flux[i] - Jan21Flares$Flux[(i-hist1) : (i + hist2)]) /Jan21Flares$Flux[i],
    Jan21Flares$Flare[i],
    Jan21Flares$secs_since_2000[i]
  )
  j = j + 1
}
write_csv(as.data.frame(Jan21FlareProfiles) , file="C:/Users/bklingen/Desktop/SolarFlareNN/Jan21FlareProfiles.csv")
```

## Load January Predictions from NN into R
```{r}
Jan21Pred = read_csv(file="C:/Users/bklingen/Desktop/SolarFlareNN/Jan21Predictions.csv", col_names='predProb')
Jan21Flares1 = cbind(Jan21Flares[Jan21Indices,], Jan21Pred)
cutoff = 0.5
Jan21Flares1 = Jan21Flares1 %>% mutate(yhat = 1*(predProb > cutoff), 
                                       agree = factor(10*Flare + yhat, levels = c(0,1,10,11), labels=c('nf,nf', 'nf,f', 'f,nf', 'f,f')))
#head(Jan21Flares1)
table(Jan21Flares1$Flare, Jan21Flares1$yhat)
```
Show GOES identified and not identified flares:
```{r}
library(ggplot2)

fluxPlot = ggplot(data=Jan21Flares1, aes(x=Date, y=Flux)) + 
  geom_vline(data=Jan21Flares1 %>% filter(yhat == 1, Flare == 0), aes(xintercept=Date), color='green', linewidth=0.6, alpha=0.5)

fluxPlot1 = fluxPlot + geom_vline(data=Jan21Flares1 %>% filter(Flare == 1), aes(xintercept=Date), color='red', linewidth=0.6, alpha=0.5)

fluxPlot2 = fluxPlot1 + 
  geom_point() +
  coord_cartesian(y = c(NA,5.1e-07))

fluxPlot2
```

Or, coloring dots:
```{r, fig.width=4, fig.height=1.5}
library(ggplot2)

summary(Jan21Flares1$agree)

fluxPlot3 = ggplot(data=Jan21Flares1 %>% select(-Status) %>% drop_na() 
                     # filter(Date > '2021-01-13 2:00', Date < '2021-01-13 4:00')
                   , aes(x=Date, y=Flux, fill = agree)) + 
  geom_point(size = 1.6, pch=21, alpha=0.5, color='white') +
  coord_cartesian(y = c(NA,5e-07)) +
  scale_fill_manual(
    limits = c('nf,f', 'f,f'),
    labels = c('nf,f' = 'new', 'f,f' = 'conventional'),
    values = c('nf,nf' = 'transparent', 
               'nf,f' = 'green',
               'f,nf' = 'blue',
               'f,f' = 'red'),
    name = 'Flare Detection Algorithm:'
  ) +
  theme_bw() +
  theme(
    legend.position = 'top'
  )

fluxPlot3
ggsave(filename = 'C:/Users/bklingen/Desktop/SolarFlareNN/Jan21Predictions.png', 
       plot = fluxPlot3,
       width = 6,
       height = 3,
       units = 'in')

```

## Plot 2021 flare data
```{r}
ggplot(data = Flares2021 %>%
         filter(Date > '2021-02-22 02:00', Date < '2021-02-22 08:00'),
       aes(x = Date, y = Flux)
       ) +
  geom_line(size=0.1)
  #coord_cartesian(ylim=c(NA, 0.5e-05))
```

## Plot random flare profiles
```{r}
exampleFluxes = tibble(
    flux = c(unlist(FlareProfiles[100, (1:(hist1+hist2+1))]),
             unlist(FlareProfiles[50, (1:(hist1+hist2+1))]),
             unlist(FlareProfiles[110, (1:(hist1+hist2+1))]),
             unlist(NotFlareProfiles[1, (1:(hist1+hist2+1))]),
             unlist(NotFlareProfiles[3, (1:(hist1+hist2+1))]),
             unlist(NotFlareProfiles[10, (1:(hist1+hist2+1))])
    ),
    flare = rep(c(1,2,3,4,5,6), each=91),
    type = rep(c('Yes','Yes','Yes', 'No', 'No','No'), each = 91),
    dates = rep(seq(-60,30), 6)
  )


ggplot(data = exampleFluxes, aes(x = dates, y = flux, color=factor(flare))) +
  geom_line(size=0.8)+
  facet_wrap(vars(type))
  #coord_cartesian(ylim=c(NA, 0.5e-05))
```



